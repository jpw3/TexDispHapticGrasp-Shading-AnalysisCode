---
title: "TexDispHapGrasp_Shading_analysis"
author: "James Wilmott"
date: "11/28/2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#OVERVIEW OF EXPERIMENT

This experiment was a haptic training task that was part of a larger study designed to assess whether cue weights are assigned according to reliabilities as per the Maximum Likelihood Estimation theoretical framework, or are otherwise assigned according to a deterministic mapping between sensory signal and depth estimation (related through a 'gain'). If cue weights are assigned according to reliabilities, then the design of this haptic training task should not elicit any changes in cue weights because there is no 'error' signal that should drive the visual system to downweight a given cue. However, if cue weights are determined according to gains as formulated by the Intrinsic Constraint model, then we should observe a decrease in texture weight with repeated exposure to this haptic training task.

The structure of the experiment was such that each participant completed 2 blocks of 108 reach-to-grasp trials on each day. Below here I import and preprocess the reaching data, but do not display the code. Note that after this step I have filtered out invalid trials, defined as a trial in which a large number of samples is missing from the data or they took too long to complete the reach.

#GOAL OF THE ANALYSES

In our first rendition of this experiment we observed that the rendered depth of the object modulated the planned grip aperture of the observer as the observer's hand got closer to the physical object they were actually grasping: the grip aperture was larger for larger rendered depths than for smaller rendered depths. This difference was further modulated by proximity to the completion of the grasp: as the hand got nearer to the object, the difference in grip aperture between larger and smaller rendered depths increased. However, there was no effect of the texture type on panned grip size, meaning that there was no difference in grip aperture across the different texture types.

Here, we will determine how adding shading to the stimulus affected how observers completed the task. We will try to replicate the findings of the initial experiment while also seeing if there might be some differences between texture (and shading) conditions.

```{r, echo=FALSE, include=FALSE}
#initialize the environment and set parameters
library(tidyr)
library(broom)
library(aod)
library(ggplot2)
library(lme4)
library(dplyr)
library(optimx)
library(gridExtra)
library(grid)
library(data.table)
library(purrr)

datapath <-  '/Users/james/Documents/R/TexDispHapticGrasp-Shading/data/';  
figsavepath <-  '/Users/james/Documents/R/TexDispHapticGrasp-Shading/figures/';

ids <- c('eoi','rhh','baf','at','lg'); #'mm',
viewing_distances <- c('-420');

#define a function to compute the between-participants standard error
computeBSSEM <- function(means_vector){
  #computes the between-subject standard error, given a vector of length (nr subjects) correponding to the means
  grand_mean <- mean(na.omit(means_vector)); #omit the NaNs if applicable
  err <- means_vector-grand_mean; #get the error, will be a vector
  squared_err <- err**2; #squared error
  non_nans <- squared_err[!(is.na(squared_err))]; #only get the values that are not NaNs
  n <- length(non_nans);
  MSE <- sum(non_nans) / (n-1);
  denom <- sqrt(n);
  estimate <- sqrt(MSE) / denom;
  return(estimate);
}

#A note on fail codes: I believe the mapping is the following: 0 = successful trial, 1 = too many missing samples (occluded markers), 2 = missed the object, and 3 = too slow

#create empty vectors to hold the data summary data for each trial
sids <- c(); tnrs <- c(); bnrs <- c(); GAs <- c(); depths <-c(); fcodes <- c(); timesteps <- c(); ttypes <- c();

#create empty vectors to hold the data summary data for each trial
subids <- c(); sessionnrs <- c(); trialnrs <- c(); failcodes <- c(); texturetypes <- c(); simulateddepths <- c(); touchtimes <- c(); endtimes <- c(); starttimes <- c(); MGAs <- c(); fiveGAs <- c(); tenGAs <- c(); fifteenGAs <- c();  iterator = 1; # adjustedgrips <- c(); 

for (subid in ids) {
    #get the filenames corresponding to each session and trial for this participant
    filenames = list.files(paste(datapath,subid,'/',sep = ""),paste(subid)); 
    
    #import each file
    for (f in filenames) {
       x <- read.table(paste(datapath,subid,'/', f, sep=""), header = TRUE, stringsAsFactors = TRUE, fill = TRUE);       #^ note that the last row will have values that are not necessarrilly arranged correctly; what should be correct is endTime in this last row
       #now, for a given trial, get the kinematic variables of interest and populate the vectors
       #for MGA, only get the max grip for the initial movement (e.g., until the grip aperture velocity first goes to 0), excluding corrections
       
       frames_occluded <- max(x$framesOccluded,na.rm=TRUE);
       if ((frames_occluded > 20)|(max(x$handOnObj,na.rm=TRUE)==0)|(max(x$failCause,na.rm=TRUE)>0)) { #if too many samples are missing or too slow, cut this trial from analyses
         max_GA <- NA; st <- NA; tt <- NA; et <- NA; fivemm_away_GA <- NA; tenmm_away_GA <- NA; fifteenmm_away_GA<-NA;
         
        #also append the individual trial data
        fail <- max(x$failCause,na.rm=TRUE); 
        fcodes <- append(fcodes, rep(fail,length(x$failCause))); 
        timesteps <- append(timesteps, seq(1, length(x$subjName), 1)); #this will correspond to the number of the frame through the movement
        ttypes <- append(ttypes, x$textureType);
        sids <- append(sids, as.character(x$subjName)); depths <- append(depths, x$simulatedDepth);
        tnrs <- append(tnrs, x$trialN); bnrs <- append(bnrs, x$sessionNR); GAs <- append(GAs, x$gripAperture);
         
       } else {
         #assign the total trial values to the appropriate vectors
        fail <- max(x$failCause,na.rm=TRUE); 
        fcodes <- append(fcodes, rep(fail,length(x$failCause))); 
        ttypes <- append(ttypes, x$textureType);
        timesteps <- append(timesteps, seq(1, length(x$subjName), 1)); #this will correspond to the number of the frame through the movement
        sids <- append(sids, as.character(x$subjName)); depths <- append(depths, x$simulatedDepth);
        tnrs <- append(tnrs, x$trialN); bnrs <- append(bnrs, x$sessionNR); GAs <- append(GAs, x$gripAperture);
         
         #V WILL THIS BOOLEAN CORRECTLY CUT OUT ADJUSTMENTS AT THE HAPTIC STIMULUS???????????
         inflight <- x[x$gripApertureVel>0 & x$distFromObjVel>0 & x$handTouchObj==0,];#get indices of initial movement via boolean
         max_GA <- max(inflight$gripAperture, na.rm = TRUE);
         
         #get the GA for 15, 10 and 5 mm before the thumb touches the object
         #get the row index corresponding to the first sample were the hand is on the haptic stimulus
         row_ <- match(1,x$handOnObj);
         #get the thumb x,y,z at time of touch
         thmb_x <- x$thumbXraw[row_]; thmb_y <- x$thumbYraw[row_]; thmb_z <- x$thumbZraw[row_];
         dist <- sqrt((x$thumbXraw-thmb_x)^2 + (x$thumbYraw-thmb_y)^2 + (x$thumbZraw-thmb_z)^2)[1:row_];
         
         ##find the row index of the sample that is closest to 5 mm away
         five_row <- match(min(abs(dist-5),na.rm=TRUE),abs(dist-5));
         if (dist[five_row] == 5) { #conditional to ensure not getting the point where thumb makes contact
           five_row = five_row -1;
         }
         #get grip aperture at 5 mm away
         fivemm_away_GA <- x$gripAperture[five_row];

        ##find the row index of the sample that is closest to 10 mm away
         ten_row <- match(min(abs(dist-10),na.rm=TRUE),abs(dist-10));
         if (dist[ten_row] == 10) { #conditional to ensure not getting the point where thumb makes contact
           ten_row = ten_row -1;
         }
         #get grip aperture at 10 mm away
         tenmm_away_GA <- x$gripAperture[ten_row]; 
         
        ##find the row index of the sample that is closest to 15 mm away
         fifteen_row <- match(min(abs(dist-15),na.rm=TRUE),abs(dist-15));
         if (dist[fifteen_row] == 15) { #conditional to ensure not getting the point where thumb makes contact
           fifteen_row = fifteen_row -1;
         }
         #get grip aperture at 10 mm away
         fifteenmm_away_GA <- x$gripAperture[fifteen_row];          

         st <- max(x$startTime,na.rm = TRUE); tt <- max(x$touchTime,na.rm = TRUE); et <- max(x$endTime,na.rm = TRUE);         
       }
       

       #populate the data arrays
       subids[iterator] <- as.character(x$subjName[1]); sessionnrs[iterator] <- x$sessionNR[1]; trialnrs[iterator] <- x$trialN[1]; failcodes[iterator] <- max(x$failCause, na.rm = TRUE); texturetypes[iterator] <- x$textureType[1]; simulateddepths[iterator] <- x$simulatedDepth[1]; touchtimes[iterator] <- tt; endtimes[iterator] <- et; starttimes[iterator] <- st; MGAs[iterator] <- max_GA; fiveGAs[iterator] <- fivemm_away_GA; tenGAs[iterator] <- tenmm_away_GA; fifteenGAs[iterator] <- fifteenmm_away_GA; 
       
       iterator = iterator + 1; #iterate
    }
}

#add the all trial data to a (massive) dataframe
all_GA_data <- data.frame(subid = sids, sessionnr = bnrs, texturetype = ttypes, trialnr = tnrs, simulateddepth = depths, timestep = timesteps, GA = GAs, failcodes = fcodes);

#add the data vectors to a data frame for the summary data
subject_data <- data.frame(subid = subids, sessionnr = sessionnrs, trialnr = trialnrs, failcode = failcodes, texturetype = texturetypes, simulateddepth = simulateddepths, touchtime = touchtimes, endtime = endtimes, starttime = starttimes, MGA = MGAs, fiveGA = fiveGAs, tenGA = tenGAs, fifteenGA = fifteenGAs);


```

#1. PLOT THE RAW GRIP APERTURE PROFILES ACROSS VALID TRIALS

A first pass analysis is to observe how the raw grip aperture evolves with time across different depths and with more experience with the task. Here, I plot for each participant the raw profiles for the trials in which there was satisfactory data (there were no fail codes etc.).

```{r}
#for each participant, loop through the big data set and plot the raw profiles via line plots for VALID trials
#do this for each set of blocks (1 + 2 were the first day, 3 + 4 the second day, and 5+6 the third day)
for (subid in ids) {
  #first, get the data only for the first day
  first_day_data <- all_GA_data[(all_GA_data$subid==subid)&((all_GA_data$sessionnr==1)|(all_GA_data$sessionnr==2))&(all_GA_data$failcodes==0),];
  
  first_day_25_data <- first_day_data[first_day_data$simulateddepth==25,];
  
  first_day_25_plot <- ggplot(first_day_25_data, aes(x = timestep, y = GA, color = factor(texturetype))) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(size=5.0,colour = "black"), axis.ticks = element_line(size=1.4), axis.ticks.length=unit(0.2, "in")) + scale_y_continuous("Grip aperture")  + scale_x_continuous("Sample number", limits = c(0,100))  + geom_point(alpha = 0.5) + ggtitle(paste("Subject ",subid," , Day 1, Depth 25"));
  
  print(first_day_25_plot);
  
   first_day_35_data <- first_day_data[first_day_data$simulateddepth==35,];
  
  first_day_35_plot <- ggplot(first_day_35_data, aes(x = timestep, y = GA, color = factor(texturetype))) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(size=5.0,colour = "black"), axis.ticks = element_line(size=1.4), axis.ticks.length=unit(0.2, "in")) + scale_y_continuous("Grip aperture")  + scale_x_continuous("Sample number", limits = c(0,100))  + geom_point(alpha = 0.5) + ggtitle(paste("Subject ",subid," , Day 1, Depth 35"));
  
  print(first_day_35_plot); 
  
  first_day_45_data <- first_day_data[first_day_data$simulateddepth==45,];
  
  first_day_45_plot <- ggplot(first_day_45_data, aes(x = timestep, y = GA, color = factor(texturetype))) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(size=5.0,colour = "black"), axis.ticks = element_line(size=1.4), axis.ticks.length=unit(0.2, "in")) + scale_y_continuous("Grip aperture")  + scale_x_continuous("Sample number", limits = c(0,100))  + geom_point(alpha = 0.5) + ggtitle(paste("Subject ",subid," , Day 1, Depth 45"));
  
  print(first_day_45_plot); 

  first_day_55_data <- first_day_data[first_day_data$simulateddepth==55,];
  
  first_day_55_plot <- ggplot(first_day_55_data, aes(x = timestep, y = GA, color = factor(texturetype))) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(size=5.0,colour = "black"), axis.ticks = element_line(size=1.4), axis.ticks.length=unit(0.2, "in")) + scale_y_continuous("Grip aperture")  + scale_x_continuous("Sample number", limits = c(0,100))  + geom_point(alpha = 0.5) + ggtitle(paste("Subject ",subid," , Day 1, Depth 55"));
  
  print(first_day_55_plot); 
  
  #second day
  sec_day_data <- all_GA_data[(all_GA_data$subid==subid)&((all_GA_data$sessionnr==3)|(all_GA_data$sessionnr==4))&(all_GA_data$failcodes==0),];
  
  sec_day_25_data <- sec_day_data[sec_day_data$simulateddepth==25,];
  
  sec_day_25_plot <- ggplot(sec_day_25_data, aes(x = timestep, y = GA, color = factor(texturetype))) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(size=5.0,colour = "black"), axis.ticks = element_line(size=1.4), axis.ticks.length=unit(0.2, "in")) + scale_y_continuous("Grip aperture")  + scale_x_continuous("Sample number", limits = c(0,100))  + geom_point(alpha = 0.5) + ggtitle(paste("Subject ",subid," , Day 2, Depth 25"));
  
  print(sec_day_25_plot);
  
   sec_day_35_data <- sec_day_data[sec_day_data$simulateddepth==35,];
  
  sec_day_35_plot <- ggplot(sec_day_35_data, aes(x = timestep, y = GA, color = factor(texturetype))) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(size=5.0,colour = "black"), axis.ticks = element_line(size=1.4), axis.ticks.length=unit(0.2, "in")) + scale_y_continuous("Grip aperture")  + scale_x_continuous("Sample number", limits = c(0,100))  + geom_point(alpha = 0.5) + ggtitle(paste("Subject ",subid," , Day 2, Depth 35"));
  
  print(sec_day_35_plot); 
  
  sec_day_45_data <- sec_day_data[sec_day_data$simulateddepth==45,];
  
  sec_day_45_plot <- ggplot(sec_day_45_data, aes(x = timestep, y = GA, color = factor(texturetype))) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(size=5.0,colour = "black"), axis.ticks = element_line(size=1.4), axis.ticks.length=unit(0.2, "in")) + scale_y_continuous("Grip aperture")  + scale_x_continuous("Sample number", limits = c(0,100))  + geom_point(alpha = 0.5) + ggtitle(paste("Subject ",subid," , Day 2, Depth 45"));
  
  print(sec_day_45_plot); 

  sec_day_55_data <- sec_day_data[sec_day_data$simulateddepth==55,];
  
  sec_day_55_plot <- ggplot(sec_day_55_data, aes(x = timestep, y = GA, color = factor(texturetype))) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(size=5.0,colour = "black"), axis.ticks = element_line(size=1.4), axis.ticks.length=unit(0.2, "in")) + scale_y_continuous("Grip aperture")  + scale_x_continuous("Sample number", limits = c(0,100))  + geom_point(alpha = 0.5) + ggtitle(paste("Subject ",subid," , Day 2, Depth 55"));
  
  print(sec_day_55_plot);  
  
  #third day
  third_day_data <- all_GA_data[(all_GA_data$subid==subid)&((all_GA_data$sessionnr==5)|(all_GA_data$sessionnr==6))&(all_GA_data$failcodes==0),];
  
  third_day_25_data <- third_day_data[third_day_data$simulateddepth==25,];
  
  third_day_25_plot <- ggplot(third_day_25_data, aes(x = timestep, y = GA, color = factor(texturetype))) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(size=5.0,colour = "black"), axis.ticks = element_line(size=1.4), axis.ticks.length=unit(0.2, "in")) + scale_y_continuous("Grip aperture")  + scale_x_continuous("Sample number", limits = c(0,100))  + geom_point(alpha = 0.5) + ggtitle(paste("Subject ",subid," , Day 3, Depth 25"));
  
  print(third_day_25_plot);
  
   third_day_35_data <- third_day_data[third_day_data$simulateddepth==35,];
  
  third_day_35_plot <- ggplot(third_day_35_data, aes(x = timestep, y = GA, color = factor(texturetype))) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(size=5.0,colour = "black"), axis.ticks = element_line(size=1.4), axis.ticks.length=unit(0.2, "in")) + scale_y_continuous("Grip aperture")  + scale_x_continuous("Sample number", limits = c(0,100))  + geom_point(alpha = 0.5) + ggtitle(paste("Subject ",subid," , Day 3, Depth 35"));
  
  print(third_day_35_plot); 
  
  third_day_45_data <- third_day_data[third_day_data$simulateddepth==45,];
  
  third_day_45_plot <- ggplot(third_day_45_data, aes(x = timestep, y = GA, color = factor(texturetype))) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(size=5.0,colour = "black"), axis.ticks = element_line(size=1.4), axis.ticks.length=unit(0.2, "in")) + scale_y_continuous("Grip aperture")  + scale_x_continuous("Sample number", limits = c(0,100))  + geom_point(alpha = 0.5) + ggtitle(paste("Subject ",subid," , Day 3, Depth 45"));
  
  print(third_day_45_plot); 

  third_day_55_data <- third_day_data[third_day_data$simulateddepth==55,];
  
  third_day_55_plot <- ggplot(third_day_55_data, aes(x = timestep, y = GA, color = factor(texturetype))) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(size=5.0,colour = "black"), axis.ticks = element_line(size=1.4), axis.ticks.length=unit(0.2, "in")) + scale_y_continuous("Grip aperture")  + scale_x_continuous("Sample number", limits = c(0,100))  + geom_point(alpha = 0.5) + ggtitle(paste("Subject ",subid," , Day 3, Depth 55"));
  
  print(third_day_55_plot);
}



```

#2. PLOT THE DISTRIBUTION OF MEAN GRIP APERTURES FOR EACH PARTICIPANT AS A FUNCTION OF EACH TEXTURE TYPE AND LOCATION (5 MM, 10 MM, 15 MM AWAY FROM STIMULUS)



# Look at the frame number when the movement starts



# A measure of how the variance of the observer's grips changed across conditions.


```{r, echo=FALSE, include=FALSE, message=FALSE}
'End of document'
```